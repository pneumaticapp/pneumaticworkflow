#!/bin/bash

# Pneumatic Workflow automated startup
# Usage: ./start.sh [address]
# Default address = "localhost"

set -e

# Get input argument or use localhost as default
ADDRESS="${1:-localhost}"

echo "Starting Pneumatic Workflow with address: $ADDRESS"

# Check if .env file exists
if [ ! -f ".env" ]; then
    echo "Creating .env file..."

    # Generate random secure passwords
    POSTGRES_PASS=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
    REDIS_PASS=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
    RABBITMQ_PASS=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)

    echo "Generating secure passwords..."

    # Create .env file (Get started + Before using in production)
    cat > .env << EOF
# Pneumatic Workflow Configuration
# Auto-generated by start.sh
# See: README.md "Get started" and "Before using in production"

# Without SSL (Get started)
BACKEND_URL=http://$ADDRESS:8001
FRONTEND_URL=http://$ADDRESS
FORMS_URL=http://form.$ADDRESS
FRONTEND_DOMAIN=$ADDRESS
BACKEND_DOMAIN=$ADDRESS
FORM_DOMAIN=form.$ADDRESS
WSS_URL=ws://$ADDRESS:8001

# Before using in production (strong passwords)
POSTGRES_PASSWORD=$POSTGRES_PASS
POSTGRES_REPLICA_PASSWORD=$POSTGRES_PASS
REDIS_PASSWORD=$REDIS_PASS
RABBITMQ_PASSWORD=$RABBITMQ_PASS
EOF

    echo ".env file created successfully with address: $ADDRESS"
    echo "Generated secure passwords for all services"
else
    echo ".env file already exists, skipping creation"
fi

echo ""
echo "Starting Docker containers..."

# Start containers
if command -v docker-compose &> /dev/null; then
    docker-compose up -d
elif command -v docker &> /dev/null && docker compose version &> /dev/null; then
    docker compose up -d
else
    echo "Error: Docker Compose not found!"
    echo "Make sure Docker and Docker Compose are installed"
    exit 1
fi

echo ""
echo "Pneumatic Workflow started successfully!"
echo ""
echo "Access information:"
echo "   Frontend: http://$ADDRESS"
echo "   Backend Admin: http://$ADDRESS:8001/admin"
echo "   Forms: http://form.$ADDRESS"
echo ""
echo "Please wait a few minutes for all services to fully start"
echo "Check status: docker compose ps"
echo "View logs: docker compose logs -f"